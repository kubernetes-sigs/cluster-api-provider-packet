name: Continuous Integration
on:
 pull_request:
   types: [opened, synchronize, reopened]
 push:
   branches:
   - main

env:
  KUBEBUILDER_DIR: /tmp/kubebuilder_install

jobs:
  report:
    name: Report
    runs-on: ubuntu-latest
    steps:
    - name: ref
      run: echo ${{ github.ref }}
    - name: event_name
      run: echo ${{ github.event_name }}
  build-test-deploy-release:
    name: Build
    runs-on: ubuntu-latest
    steps:
    - name: checkout
      uses: actions/checkout@v2.3.4
    - uses: actions/setup-go@v2
      with:
        go-version: '1.15' # The Go version to download (if necessary) and use.
    - name: kubebuilder
      run: make kubebuilder KUBEBUILDER_DIR=${KUBEBUILDER_DIR} # we use this dir because /usr/local/kubebuilder is protected
    - name: test
      run: make test KUBEBUILDER_DIR=${KUBEBUILDER_DIR}
      env:
        KUBEBUILDER_ASSETS: ${{ env.KUBEBUILDER_DIR }}/bin
    - name: Register binfmt_misc entries for qemu-user-static
      run: make register
    - name: set buildx cross-builder
      run: |
        docker buildx create --name cross-builder
        docker buildx use cross-builder
        docker buildx inspect --bootstrap
    - name: check buildx
      run: docker buildx ls
    - name: image
      run: make image-all KUBEBUILDER_DIR=${KUBEBUILDER_DIR}
      env:
        KUBEBUILDER_ASSETS: ${{ env.KUBEBUILDER_DIR }}/bin

    # these next steps are used for merge to main (push the images)
    # they really should be separate workflows or jobs, but github actions is awful about sharing between them, so it must be one job
    - name: docker login
      if: github.event_name == 'push' && endsWith(github.ref,'/main')
      run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin
    - name: deploy   # when merged into main, tag main and push - ideally, this would be a separate job, but you cannot share docker build cache between jobs
      if: github.event_name == 'push' && endsWith(github.ref,'/main')
      run: make cd CONFIRM=true BRANCH_NAME=main
